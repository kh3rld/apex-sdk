name: Daily Health Check

on:
  # Run daily at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'
  # Allow manual trigger
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

permissions:
  contents: read
  issues: write # To create issues on failures

jobs:
  # Build health check
  build-check:
    name: Build Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            target
          key: ${{ runner.os }}-cargo-health-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-health-

      - name: Check all packages build
        run: |
          echo "Building all packages..."
          cargo build --workspace --all-features
          echo "All packages build successfully"

      - name: Check examples build
        run: |
          echo "Building examples..."
          cargo build --examples --all-features
          echo "All examples build successfully"

  # Test health check
  test-check:
    name: Test Suite Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            target
          key: ${{ runner.os }}-cargo-test-health-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-health-

      - name: Run all unit tests
        run: |
          echo "Running all unit tests..."
          cargo test --workspace --lib --bins
          echo "All unit tests passed"

      - name: Run all doc tests
        run: |
          echo "Running all doc tests..."
          cargo test --workspace --doc
          echo "All doc tests passed"

  # Docker infrastructure health check
  docker-health-check:
    name: Docker Infrastructure Health
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify Docker files exist
        run: |
          echo "Checking Docker infrastructure files..."
          test -f docker-compose.yml && echo "docker-compose.yml exists"
          test -f docker/evm/Dockerfile && echo "EVM Dockerfile exists"
          test -f docker/substrate/Dockerfile && echo "Substrate Dockerfile exists"
          test -f docker/evm/hardhat.config.js && echo "Hardhat config exists"
      - name: Build Docker images
        run: |
          echo "Building Docker images..."
          docker compose build
          echo "Docker images built successfully"

      - name: Start Docker services
        run: |
          echo "Starting Docker services..."
          docker compose up -d
          sleep 20

      - name: Check service health
        run: |
          echo "Checking service health..."
          docker compose ps

          # Check EVM node
          echo "Checking EVM node..."
          for i in {1..5}; do
            if curl -f -s -X POST -H "Content-Type: application/json" \
              --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
              http://localhost:8545 > /dev/null 2>&1; then
              echo "EVM node is healthy"
              break
            fi
            echo "Attempt $i: EVM node not ready, waiting..."
            sleep 5
          done

      - name: Show logs on failure
        if: failure()
        run: |
          echo "Docker logs:"
          docker compose logs

      - name: Cleanup
        if: always()
        run: |
          docker compose down

  # Dependency health check
  dependency-check:
    name: Dependency Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-outdated
        run: cargo install cargo-outdated || true

      - name: Check for outdated dependencies
        run: |
          echo "Checking for outdated dependencies..."
          cargo outdated --workspace || echo "Some dependencies may be outdated"

      - name: Check dependency tree
        run: |
          echo "Checking dependency tree..."
          cargo tree --workspace --depth 3

  # Security health check
  security-check:
    name: Security Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit || true

      - name: Run security audit
        run: |
          echo "Running security audit..."
          cargo audit || echo "Security vulnerabilities detected"

  # Coverage health check
  coverage-check:
    name: Test Coverage Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov || true

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            target
          key: ${{ runner.os }}-cargo-cov-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-cov-

      - name: Generate coverage report
        run: |
          echo "Generating test coverage report..."
          cargo llvm-cov --workspace --lcov --output-path lcov.info || true
          cargo llvm-cov --workspace || echo "Coverage: Check detailed report"

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: lcov.info
          retention-days: 30

  # Summary and notification
  health-summary:
    name: Health Check Summary
    runs-on: ubuntu-latest
    needs: [build-check, test-check, docker-health-check, dependency-check, security-check, coverage-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Daily Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Check Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Build Check: ${{ needs.build-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test Suite: ${{ needs.test-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Infrastructure: ${{ needs.docker-health-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependencies: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: ${{ needs.coverage-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-check.result }}" == "failure" ]] || \
             [[ "${{ needs.test-check.result }}" == "failure" ]]; then
            echo "**Critical checks failed! Immediate attention required.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**All critical checks passed!**" >> $GITHUB_STEP_SUMMARY
          fi
