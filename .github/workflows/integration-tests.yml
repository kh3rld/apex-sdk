name: Integration Tests

on:
  # Run weekly on Monday at 2 AM UTC
  schedule:
    - cron: '0 2 * * 1'
  # Allow manual trigger
  workflow_dispatch:
  # Optionally run on main branch pushes
  push:
    branches: [main]
    paths:
      - '**/*.rs'
      - '**/Cargo.toml'
      - '**/Cargo.lock'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

permissions:
  contents: read

jobs:
  integration-tests:
    name: Integration Tests (${{ matrix.test-suite }})
    runs-on: ubuntu-latest
    continue-on-error: true # Don't fail CI if integration tests fail
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - evm-integration
          - substrate-integration
          - westend-integration
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry/index
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry/cache
          key: ${{ runner.os }}-cargo-cache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-cache-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-integration-

      - name: Run EVM integration tests
        if: matrix.test-suite == 'evm-integration'
        run: |
          cargo test -p apex-sdk-evm --test integration_test -- --ignored --test-threads=1
          cargo test -p apex-sdk-evm --lib -- --ignored --test-threads=1
        continue-on-error: true

      - name: Run Substrate integration tests
        if: matrix.test-suite == 'substrate-integration'
        run: |
          cargo test -p apex-sdk-substrate --lib -- --ignored --test-threads=1
        continue-on-error: true

      - name: Run Westend integration tests
        if: matrix.test-suite == 'westend-integration'
        run: |
          cargo test -p apex-sdk-substrate --test westend_integration -- --ignored --test-threads=1
        continue-on-error: true

      - name: Report results
        if: always()
        run: |
          echo "Integration test suite '${{ matrix.test-suite }}' completed"
          echo "Note: These tests may fail due to network issues or rate limiting"

  # Run all ignored tests together
  all-ignored-tests:
    name: All Ignored Tests
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry/index
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry/cache
          key: ${{ runner.os }}-cargo-cache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-cache-

      - name: Run all ignored tests
        run: |
          echo "Running all ignored tests..."
          cargo test --all-features -- --ignored --test-threads=1 || true
          echo "Integration tests completed (failures expected due to network/interaction requirements)"

      - name: Summary
        run: |
          echo "üìä Integration Test Summary"
          echo "============================"
          echo "Tests requiring network: ~45 tests"
          echo "These tests verify real network interactions with:"
          echo "  - Ethereum/EVM networks"
          echo "  - Polkadot/Substrate networks"
          echo "  - Westend testnet"
          echo ""
          echo "‚ö†Ô∏è  Note: Failures may occur due to:"
          echo "  - Network connectivity issues"
          echo "  - Rate limiting"
          echo "  - Endpoint availability"
          echo "  - Chain state changes"
