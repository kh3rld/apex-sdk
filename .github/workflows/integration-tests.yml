name: Integration Tests

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  # Allow manual trigger
  workflow_dispatch:
  # Run on main branch pushes
  push:
    branches: [main]
    paths:
      - '**/*.rs'
      - '**/Cargo.toml'
      - '**/Cargo.lock'
      - 'docker/**'
      - 'docker-compose.yml'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

permissions:
  contents: read

jobs:
  # Docker-based integration tests (new)
  docker-integration-tests:
    name: Docker Integration Tests (${{ matrix.test-suite }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - evm
          - substrate
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry/index
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry/cache
          key: ${{ runner.os }}-cargo-cache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-cache-

      - name: Cache cargo build
        uses: actions/cache@v5
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-integration-

      - name: Start Docker test nodes
        run: |
          echo "Starting Docker test nodes..."
          docker compose up -d --build
          echo "Waiting for nodes to be ready..."
          sleep 15

      - name: Verify nodes are running
        run: |
          echo "Container status:"
          docker compose ps
          echo ""
          echo "Checking node health..."
          # Check EVM node
          curl -f -X POST -H "Content-Type: application/json" \
            --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
            http://localhost:8545 || echo "EVM node may not be ready"
          echo ""

      - name: Run EVM Docker integration tests
        if: matrix.test-suite == 'evm'
        env:
          INTEGRATION_TESTS: 1
        run: |
          echo "Running EVM integration tests..."
          cargo test --test evm_integration_test -- --include-ignored --nocapture

      - name: Run Substrate Docker integration tests
        if: matrix.test-suite == 'substrate'
        env:
          INTEGRATION_TESTS: 1
        run: |
          echo "Running Substrate integration tests..."
          cargo test --test substrate_integration_test -- --include-ignored --nocapture
        continue-on-error: true # Substrate node may have health check issues

      - name: Show Docker logs on failure
        if: failure()
        run: |
          echo "Docker Compose Logs:"
          docker compose logs

      - name: Stop Docker test nodes
        if: always()
        run: |
          echo "Stopping Docker test nodes..."
          docker compose down

      - name: Report results
        if: always()
        run: |
          echo "Docker integration test suite '${{ matrix.test-suite }}' completed"

  # Existing network-based integration tests
  network-integration-tests:
    name: Network Integration Tests (${{ matrix.test-suite }})
    runs-on: ubuntu-latest
    continue-on-error: true # Don't fail CI if integration tests fail
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - evm-integration
          - substrate-integration
          - westend-integration
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry/index
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry/cache
          key: ${{ runner.os }}-cargo-cache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-cache-

      - name: Cache cargo build
        uses: actions/cache@v5
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-integration-

      - name: Run EVM integration tests
        if: matrix.test-suite == 'evm-integration'
        run: |
          cargo test -p apex-sdk-evm --test integration_test -- --ignored --test-threads=1
          cargo test -p apex-sdk-evm --lib -- --ignored --test-threads=1
        continue-on-error: true

      - name: Run Substrate integration tests
        if: matrix.test-suite == 'substrate-integration'
        run: |
          cargo test -p apex-sdk-substrate --lib -- --ignored --test-threads=1
        continue-on-error: true

      - name: Run Westend integration tests
        if: matrix.test-suite == 'westend-integration'
        run: |
          cargo test -p apex-sdk-substrate --test westend_integration -- --ignored --test-threads=1
        continue-on-error: true

      - name: Report results
        if: always()
        run: |
          echo "Integration test suite '${{ matrix.test-suite }}' completed"
          echo "Note: These tests may fail due to network issues or rate limiting"

  # Run all ignored tests together (for comprehensive check)
  all-ignored-tests:
    name: All Ignored Tests
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry/index
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry/cache
          key: ${{ runner.os }}-cargo-cache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-cache-

      - name: Run all ignored tests
        run: |
          echo "Running all ignored tests..."
          cargo test --all-features -- --ignored --test-threads=1 || true
          echo "Integration tests completed (failures expected due to network/interaction requirements)"

      - name: Summary
        run: |
          echo "Integration Test Summary"
          echo "========================"
          echo "Tests requiring network/Docker: ~50+ tests"
          echo "These tests verify real interactions with:"
          echo "  - Docker-based Hardhat (EVM) node"
          echo "  - Docker-based Substrate contracts node"
          echo "  - Ethereum/EVM networks"
          echo "  - Polkadot/Substrate networks"
          echo "  - Westend testnet"
          echo ""
          echo "Note: Failures may occur due to:"
          echo "  - Network connectivity issues"
          echo "  - Rate limiting"
          echo "  - Endpoint availability"
          echo "  - Chain state changes"
          echo "  - Docker service availability"
